<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TriAI Compare - Multi-AI Response Comparison</title>
    <meta name="description" content="Compare responses from OpenAI, Anthropic, Google, and Perplexity AI side-by-side">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/history_video.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/role_selectors.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enforcement.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/interrogation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/interrogation-modal.css') }}">
    <style>
        .sandbag-badge {
            background: rgba(255, 165, 0, 0.1);
            color: #ffa500;
            border: 1px solid rgba(255, 165, 0, 0.3);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }

            100% {
                opacity: 0.7;
            }
        }

        .sandbag-badge.hidden {
            display: none;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Background Video Container -->
    <div class="bg-video-container">
        <!-- Idle State (Low Energy) -->
        <video id="bgVideo" class="video-layer active" autoplay muted loop playsinline>
            <source src="{{ url_for('static', filename='videos/background_main.mp4') }}" type="video/mp4">
        </video>

        <!-- Processing State (High Energy) -->
        <video id="processingVideo" class="video-layer" muted loop playsinline>
            <source src="{{ url_for('static', filename='videos/processing_gold_final.mp4') }}" type="video/mp4">
        </video>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 class="logo">
                    <span class="logo-tri">Tri</span><span class="logo-ai">AI</span>
                    <span class="logo-subtitle">Compare</span>
                </h1>
                <p class="tagline">Ask once. Compare four perspectives.</p>
                <div id="currentProjectDisplay" class="current-project-display hidden">
                    <span class="label">Project:</span>
                    <span class="value" id="currentProjectName">None</span>
                    <button id="clearProject" class="clear-project-btn" title="Exit Project">√ó</button>
                </div>
            </div>

            <!-- Navbar -->
            <div class="navbar">
                <button id="projectsToggle" class="nav-btn">
                    <span class="icon">üìÇ</span> Projects
                </button>
                <button id="historyToggle" class="nav-btn">
                    <span class="icon">üìú</span> History
                </button>
                <a href="/dashboard" class="nav-btn">
                    <span class="icon">üìä</span> Learning
                </a>
            </div>
        </header>

        <!-- Projects Sidebar -->
        <aside id="projectsSidebar" class="sidebar left-sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Projects</h2>
                <button id="closeProjects" class="close-sidebar">√ó</button>
            </div>
            <div class="projects-content">
                <div class="create-project-form">
                    <input type="text" id="newProjectInput" placeholder="New Project Name...">
                    <button id="createProjectBtn">+</button>
                </div>
                <div id="projectsList" class="projects-list">
                    <!-- Project items will be injected here -->
                    <div class="loading-text">Loading projects...</div>
                </div>
            </div>
        </aside>

        <!-- History Sidebar -->
        <aside id="historySidebar" class="sidebar right-sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">History</h2>
                <button id="closeHistory" class="close-sidebar">√ó</button>
            </div>
            <div id="historyList" class="history-list">
                <!-- History items will be injected here -->
                <div class="loading-history">Loading...</div>
            </div>
        </aside>

        <!-- Input Section -->
        <section class="input-section">
            <div class="input-container">
                <textarea id="questionInput"
                    placeholder="Enter your question here... (e.g., 'Explain quantum computing in simple terms')"
                    rows="4"></textarea>
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" id="fileInput" hidden multiple
                        accept=".txt,.pdf,.md,.csv,.json,.py,.js,.html,.css,.png,.jpg,.jpeg,.webp">
                    <div class="upload-placeholder">
                        <span class="upload-icon">üìÅ</span>
                        <span class="upload-text">Drag file or click to upload context (PDF, Img, Code)</span>
                    </div>
                    <div class="file-preview hidden" id="filePreview">
                        <span class="file-name">example.pdf</span>
                        <button class="remove-file">√ó</button>
                    </div>
                </div>

                <!-- Active Models Section -->
                <div class="model-selection-area">
                    <span class="section-label">ACTIVE MODELS:</span>
                    <div class="model-toggles">
                        <button class="model-toggle active" data-model="openai">
                            <span class="status-icon">‚úì</span> GPT-5.2
                        </button>
                        <button class="model-toggle active" data-model="anthropic">
                            <span class="status-icon">‚úì</span> Claude S4
                        </button>
                        <button class="model-toggle active" data-model="google">
                            <span class="status-icon">‚úì</span> Gemini 3.0
                        </button>
                        <button class="model-toggle active" data-model="perplexity">
                            <span class="status-icon">‚úì</span> Perplexity
                        </button>
                    </div>
                </div>

                <!-- Council Role Selectors (shown when Council Mode is ON) -->
                <div id="roleSelectors" class="role-selectors hidden">
                    <!-- Recommendation UI -->
                    <div id="roleRecommendation" class="recommended-council-box hidden">
                        <div class="rec-header">
                            <span class="rec-icon">üèõÔ∏è</span>
                            <div class="rec-text">
                                <span class="rec-label">Query detected:</span>
                                <span id="detectedCategory" class="rec-category">Analyzing...</span>
                            </div>
                        </div>
                        <div class="rec-suggestion">
                            <p>Recommended Council configuration:</p>
                            <ul id="recommendedRolesList">
                                <!-- Roles will be injected here -->
                            </ul>
                            <div class="rec-meta">
                                This configuration has <span id="recRating">--</span> avg rating
                            </div>
                        </div>
                        <div class="rec-actions">
                            <button id="useRecommendedBtn" class="rec-btn primary">Use Recommended</button>
                            <button id="customizeRolesBtn" class="rec-btn secondary">Customize</button>
                        </div>
                    </div>

                    <div class="role-selector-header">
                        <span class="roles-title">üèõÔ∏è Assign Council Roles:</span>
                    </div>
                    <div class="role-selector-grid">
                        <div class="role-assignment">
                            <label class="role-label">OpenAI (GPT-5.2):</label>
                            <select id="roleOpenAI" class="role-dropdown">
                                {% for key, role in roles.items() %}
                                <option value="{{ key }}" {% if defaults.openai==key %}selected{% endif %}>
                                    {{ role.icon }} {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <!-- Visual Profile Dropdown -->
                            <div class="visual-profile-container">
                                <label class="profile-label">Visual Profile:</label>
                                <select id="visualOpenAI" class="profile-dropdown">
                                    <option value="off" selected>Off</option>
                                    <option value="auto">Auto (Role-Matched)</option>
                                    <option value="realistic">Realistic (Banana Render)</option>
                                    <option value="blueprint">Blueprint (Banana Schematic)</option>
                                    <option value="data-viz">Data-Viz (Mermaid Chart)</option>
                                    <option value="knowledge-graph">Knowledge Graph (Mermaid)</option>
                                </select>
                            </div>
                        </div>
                        <div class="role-assignment">
                            <label class="role-label">Anthropic (Claude):</label>
                            <select id="roleAnthropic" class="role-dropdown">
                                {% for key, role in roles.items() %}
                                <option value="{{ key }}" {% if defaults.anthropic==key %}selected{% endif %}>
                                    {{ role.icon }} {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <!-- Visual Profile Dropdown -->
                            <div class="visual-profile-container">
                                <label class="profile-label">Visual Profile:</label>
                                <select id="visualAnthropic" class="profile-dropdown">
                                    <option value="off" selected>Off</option>
                                    <option value="auto">Auto (Role-Matched)</option>
                                    <option value="realistic">Realistic (Banana Render)</option>
                                    <option value="blueprint">Blueprint (Banana Schematic)</option>
                                    <option value="data-viz">Data-Viz (Mermaid Chart)</option>
                                    <option value="knowledge-graph">Knowledge Graph (Mermaid)</option>
                                </select>
                            </div>
                        </div>
                        <div class="role-assignment">
                            <label class="role-label">Google (Gemini):</label>
                            <select id="roleGoogle" class="role-dropdown">
                                {% for key, role in roles.items() %}
                                <option value="{{ key }}" {% if defaults.google==key %}selected{% endif %}>
                                    {{ role.icon }} {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <!-- Visual Profile Dropdown -->
                            <div class="visual-profile-container">
                                <label class="profile-label">Visual Profile:</label>
                                <select id="visualGoogle" class="profile-dropdown">
                                    <option value="off" selected>Off</option>
                                    <option value="auto">Auto (Role-Matched)</option>
                                    <option value="realistic">Realistic (Banana Render)</option>
                                    <option value="blueprint">Blueprint (Banana Schematic)</option>
                                    <option value="data-viz">Data-Viz (Mermaid Chart)</option>
                                    <option value="knowledge-graph">Knowledge Graph (Mermaid)</option>
                                </select>
                            </div>
                        </div>
                        <div class="role-assignment">
                            <label class="role-label">Perplexity:</label>
                            <select id="rolePerplexity" class="role-dropdown">
                                {% for key, role in roles.items() %}
                                <option value="{{ key }}" {% if defaults.perplexity==key %}selected{% endif %}>
                                    {{ role.icon }} {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <!-- Visual Profile Dropdown -->
                            <div class="visual-profile-container">
                                <label class="profile-label">Visual Profile:</label>
                                <select id="visualPerplexity" class="profile-dropdown">
                                    <option value="off" selected>Off</option>
                                    <option value="auto">Auto (Role-Matched)</option>
                                    <option value="realistic">Realistic (Banana Render)</option>
                                    <option value="blueprint">Blueprint (Banana Schematic)</option>
                                    <option value="data-viz">Data-Viz (Mermaid Chart)</option>
                                    <option value="knowledge-graph">Knowledge Graph (Mermaid)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-actions">
                    <div class="switch-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="vaultToggle">
                            <span class="slider round"></span>
                            <span class="toggle-label">Vault Context</span>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="citationToggle">
                            <span class="slider round"></span>
                            <span class="toggle-label">Citations</span>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="thoughtToggle">
                            <span class="slider round"></span>
                            <span class="toggle-label">Thoughts</span>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="podcastToggle">
                            <span class="slider round"></span>
                            <span class="toggle-label">Podcast Mode</span>
                        </label>
                        <label class="toggle-switch council-switch">
                            <input type="checkbox" id="councilToggle">
                            <span class="slider round"></span>
                            <span class="toggle-label">Council üèõÔ∏è</span>
                        </label>
                        <label class="toggle-switch" title="Total Persona Lockdown: 100% Rejection of Generic Fillers">
                            <input type="checkbox" id="hardModeToggle">
                            <span class="slider round"></span>
                            <span class="toggle-label">Hard Mode ‚ö°</span>
                        </label>
                        <!-- WORKFLOW MODE TOGGLE -->
                        <label class="toggle-switch" title="Execute multi-step industrial workflows">
                            <input type="checkbox" id="workflowToggle">
                            <span class="slider round"></span>
                            <span class="toggle-label">Workflow üåä</span>
                        </label>
                    </div>

                    <!-- Workflow Template Selector (Hidden by default) -->
                    <div id="workflowArea" class="workflow-selector-area hidden">
                        <span class="section-label">SELECT WORKFLOW:</span>
                        <select id="workflowSelect" class="role-dropdown">
                            <option value="">-- Choose a workflow --</option>
                        </select>
                    </div>

                    <button id="micBtn" class="icon-button" title="Voice Input">
                        üé§
                    </button>
                    <button id="cameraBtn" class="icon-button" title="Take Photo (Mobile/Webcam)">
                        üì∏
                    </button>
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>
                    <button id="clearDeckBtn" class="icon-button" title="Clear Deck (Reset All)"
                        style="background: rgba(255, 0, 0, 0.2); color: #ff6b6b; border: 1px solid rgba(255, 0, 0, 0.3);">
                        üóëÔ∏è
                    </button>
                    <button id="visualizeBtn" class="ask-button secondary-btn"
                        style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); margin-right: 10px;"
                        title="Generate AI Analysis + Visual Mockup">
                        <span class="button-text">Visualize</span>
                        <span class="button-icon">üé®</span>
                    </button>
                    <button id="askButton" class="ask-button">
                        <span class="button-text">Ask All AIs</span>
                        <span class="button-icon">‚Üí</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Mermaid for Charts -->
        <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({ startOnLoad: false, theme: 'dark' });</script>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state hidden">
            <div class="loading-spinner"></div>
            <p id="loadingStatusText">Querying models...</p>
        </div>

        <!-- Consensus Section -->
        <section id="consensusSection" class="consensus-section hidden">
            <div class="consensus-card">
                <h3>ü§ñ AI Consensus Analysis</h3>
                <div id="consensusContent" class="consensus-content">
                    Loading analysis...
                </div>
                <div class="consensus-actions">
                    <button id="listenBtn" class="action-btn" title="Read Aloud">
                        <span class="icon">üîä</span> Listen
                    </button>
                    <button id="obsidianBtn" class="action-btn" title="Save to Obsidian Vault">
                        <span class="icon">üíæ</span> Save to Vault
                    </button>
                    <button id="exportBtn" class="action-btn" title="Download Markdown Report">
                        <span class="icon">‚¨áÔ∏è</span> Export Report
                    </button>
                </div>

                <!-- Feedback Square -->
                <div id="feedbackSquare" class="feedback-square hidden">
                    <div class="feedback-header">
                        <h4>‚≠ê How helpful was this analysis?</h4>
                    </div>
                    <div class="rating-options">
                        <button class="rating-btn" data-rating="1" title="Not Helpful">üòû</button>
                        <button class="rating-btn" data-rating="2" title="Okay">üòê</button>
                        <button class="rating-btn" data-rating="3" title="Helpful">üòä</button>
                        <button class="rating-btn" data-rating="4" title="Excellent">ü§©</button>
                    </div>
                    <div class="feedback-issues hidden">
                        <label class="issue-item">
                            <input type="checkbox" name="too_generic">
                            <span class="checkbox-custom"></span> Response was too generic
                        </label>
                        <label class="issue-item">
                            <input type="checkbox" name="hallucinated">
                            <span class="checkbox-custom"></span> Hallucinated facts/versions
                        </label>
                        <label class="issue-item">
                            <input type="checkbox" name="mandate_fail">
                            <span class="checkbox-custom"></span> Failed Forensic Mandate
                        </label>
                        <label class="issue-item">
                            <input type="checkbox" name="cushioning_present">
                            <span class="checkbox-custom"></span> Excessive narrative cushioning
                        </label>
                        <label class="issue-item">
                            <input type="checkbox" name="visual_mismatch">
                            <span class="checkbox-custom"></span> Visual didn't match logic
                        </label>
                        <label class="issue-item">
                            <input type="checkbox" name="missing_details">
                            <span class="checkbox-custom"></span> Missing technical details
                        </label>
                        <label class="issue-item">
                            <input type="checkbox" name="wrong_roles">
                            <span class="checkbox-custom"></span> Wrong role assignments
                        </label>
                        <label class="issue-item">
                            <input type="checkbox" name="didnt_answer">
                            <span class="checkbox-custom"></span> Didn't answer my question
                        </label>
                    </div>
                    <div class="feedback-comment">
                        <textarea id="feedbackText" placeholder="Optional: Add specific feedback..."></textarea>
                    </div>
                    <button id="submitFeedbackBtn" class="submit-feedback-btn">Submit Feedback</button>
                    <div id="feedbackThanks" class="feedback-thanks hidden">
                        <p>‚ú® Thank you for your feedback!</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Grid -->
        <section id="resultsSection" class="results-section hidden">
            <div class="results-grid">
                <!-- OpenAI Response -->
                <div class="ai-card" data-ai="openai">
                    <div class="ai-header">
                        <div class="ai-info">
                            <h2 class="ai-name">OpenAI</h2>
                            <span class="ai-model" id="openai-model">GPT-4o</span>
                            <span class="sandbag-badge hidden" id="openai-sandbag"
                                title="Heavy reasoning detected in thoughts. The good stuff might be hidden!">üõ∏
                                Sandbagging?</span>
                            <span class="bias-badge hidden" id="openai-bias"></span>
                        </div>
                        <div class="card-rating" data-ai="openai">
                            <button class="card-rate-btn up" title="Helpful answer">üëç</button>
                            <button class="card-rate-btn down" title="Generic or unhelpful">üëé</button>
                        </div>
                        <div class="ai-meta">
                            <span class="cost-tag" id="openai-cost">$0.000</span>
                            <span class="response-time" id="openai-time">-- s</span>
                            <button class="copy-button download-card-btn" data-target="openai"
                                title="Download as Markdown">
                                <span class="icon">üíæ</span>
                            </button>
                            <button class="copy-button visualize-btn" data-target="openai"
                                title="Visualize data as chart">
                                <span class="icon">üìä</span>
                            </button>
                            <button class="copy-button" data-target="openai" title="Copy to clipboard">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path
                                        d="M13.5 5.5H6.5C5.67157 5.5 5 6.17157 5 7V14C5 14.8284 5.67157 15.5 6.5 15.5H13.5C14.3284 15.5 15 14.8284 15 14V7C15 6.17157 14.3284 5.5 13.5 5.5Z"
                                        stroke="currentColor" stroke-width="1.5" />
                                    <path
                                        d="M3 10.5H2.5C1.67157 10.5 1 9.82843 1 9V2C1 1.17157 1.67157 0.5 2.5 0.5H9.5C10.3284 0.5 11 1.17157 11 2V2.5"
                                        stroke="currentColor" stroke-width="1.5" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Thoughts container (hidden by default) -->
                    <div id="openai-thought" class="thought-container hidden">
                        <details>
                            <summary>üëÅÔ∏è View Reasoning Trace</summary>
                            <div class="thought-content"></div>
                        </details>
                    </div>
                    <div class="ai-response">
                        <div id="openai-response" class="response-text">Waiting for response...</div>
                    </div>
                    <div class="ai-status" id="openai-status"></div>
                </div>

                <!-- Anthropic Response -->
                <div class="ai-card" data-ai="anthropic">
                    <div class="ai-header">
                        <div class="ai-info">
                            <h2 class="ai-name">Anthropic</h2>
                            <span class="ai-model" id="anthropic-model">Claude Sonnet 4</span>
                            <span class="sandbag-badge hidden" id="anthropic-sandbag"
                                title="Heavy reasoning detected in thoughts. The good stuff might be hidden!">üõ∏
                                Sandbagging?</span>
                            <span class="bias-badge hidden" id="anthropic-bias"></span>
                        </div>
                        <div class="card-rating" data-ai="anthropic">
                            <button class="card-rate-btn up" title="Helpful answer">üëç</button>
                            <button class="card-rate-btn down" title="Generic or unhelpful">üëé</button>
                        </div>
                        <div class="ai-meta">
                            <span class="cost-tag" id="anthropic-cost">$0.000</span>
                            <span class="response-time" id="anthropic-time">-- s</span>
                            <button class="copy-button download-card-btn" data-target="anthropic"
                                title="Download as Markdown">
                                <span class="icon">üíæ</span>
                            </button>
                            <button class="copy-button visualize-btn" data-target="anthropic"
                                title="Visualize data as chart">
                                <span class="icon">üìä</span>
                            </button>
                            <button class="copy-button" data-target="anthropic" title="Copy to clipboard">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path
                                        d="M13.5 5.5H6.5C5.67157 5.5 5 6.17157 5 7V14C5 14.8284 5.67157 15.5 6.5 15.5H13.5C14.3284 15.5 15 14.8284 15 14V7C15 6.17157 14.3284 5.5 13.5 5.5Z"
                                        stroke="currentColor" stroke-width="1.5" />
                                    <path
                                        d="M3 10.5H2.5C1.67157 10.5 1 9.82843 1 9V2C1 1.17157 1.67157 0.5 2.5 0.5H9.5C10.3284 0.5 11 1.17157 11 2V2.5"
                                        stroke="currentColor" stroke-width="1.5" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Thoughts container (hidden by default) -->
                    <div id="anthropic-thought" class="thought-container hidden">
                        <details>
                            <summary>üëÅÔ∏è View Reasoning Trace</summary>
                            <div class="thought-content"></div>
                        </details>
                    </div>
                    <div class="ai-response">
                        <div id="anthropic-response" class="response-text">Waiting for response...</div>
                    </div>
                    <div class="ai-status" id="anthropic-status"></div>
                </div>

                <!-- Google Response -->
                <div class="ai-card" data-ai="google">
                    <div class="ai-header">
                        <div class="ai-info">
                            <h2 class="ai-name">Google</h2>
                            <span class="ai-model" id="google-model">Gemini 2.5</span>
                            <span class="sandbag-badge hidden" id="google-sandbag"
                                title="Heavy reasoning detected in thoughts. The good stuff might be hidden!">üõ∏
                                Sandbagging?</span>
                            <span class="bias-badge hidden" id="google-bias"></span>
                        </div>
                        <div class="card-rating" data-ai="google">
                            <button class="card-rate-btn up" title="Helpful answer">üëç</button>
                            <button class="card-rate-btn down" title="Generic or unhelpful">üëé</button>
                        </div>
                        <div class="ai-meta">
                            <span class="cost-tag" id="google-cost">$0.000</span>
                            <span class="response-time" id="google-time">-- s</span>
                            <button class="copy-button download-card-btn" data-target="google"
                                title="Download as Markdown">
                                <span class="icon">üíæ</span>
                            </button>
                            <button class="copy-button visualize-btn" data-target="google"
                                title="Visualize data as chart">
                                <span class="icon">üìä</span>
                            </button>
                            <button class="copy-button" data-target="google" title="Copy to clipboard">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path
                                        d="M13.5 5.5H6.5C5.67157 5.5 5 6.17157 5 7V14C5 14.8284 5.67157 15.5 6.5 15.5H13.5C14.3284 15.5 15 14.8284 15 14V7C15 6.17157 14.3284 5.5 13.5 5.5Z"
                                        stroke="currentColor" stroke-width="1.5" />
                                    <path
                                        d="M3 10.5H2.5C1.67157 10.5 1 9.82843 1 9V2C1 1.17157 1.67157 0.5 2.5 0.5H9.5C10.3284 0.5 11 1.17157 11 2V2.5"
                                        stroke="currentColor" stroke-width="1.5" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Thoughts container (hidden by default) -->
                    <div id="google-thought" class="thought-container hidden">
                        <details>
                            <summary>üëÅÔ∏è View Reasoning Trace</summary>
                            <div class="thought-content"></div>
                        </details>
                    </div>
                    <div class="ai-response">
                        <div id="google-response" class="response-text">Waiting for response...</div>
                    </div>
                    <div class="ai-status" id="google-status"></div>
                </div>

                <!-- Perplexity Response -->
                <div class="ai-card" data-ai="perplexity">
                    <div class="ai-header">
                        <div class="ai-info">
                            <h2 class="ai-name">Perplexity</h2>
                            <span class="ai-model" id="perplexity-model">Sonar</span>
                            <span class="sandbag-badge hidden" id="perplexity-sandbag"
                                title="Heavy reasoning detected in thoughts. The good stuff might be hidden!">üõ∏
                                Sandbagging?</span>
                            <span class="bias-badge hidden" id="perplexity-bias"></span>
                        </div>
                        <div class="card-rating" data-ai="perplexity">
                            <button class="card-rate-btn up" title="Helpful answer">üëç</button>
                            <button class="card-rate-btn down" title="Generic or unhelpful">üëé</button>
                        </div>
                        <div class="ai-meta">
                            <span class="cost-tag" id="perplexity-cost">$0.000</span>
                            <span class="response-time" id="perplexity-time">-- s</span>
                            <button class="copy-button download-card-btn" data-target="perplexity"
                                title="Download as Markdown">
                                <span class="icon">üíæ</span>
                            </button>
                            <button class="copy-button visualize-btn" data-target="perplexity"
                                title="Visualize data as chart">
                                <span class="icon">üìä</span>
                            </button>
                            <button class="copy-button" data-target="perplexity" title="Copy to clipboard">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path
                                        d="M13.5 5.5H6.5C5.67157 5.5 5 6.17157 5 7V14C5 14.8284 5.67157 15.5 6.5 15.5H13.5C14.3284 15.5 15 14.8284 15 14V7C15 6.17157 14.3284 5.5 13.5 5.5Z"
                                        stroke="currentColor" stroke-width="1.5" />
                                    <path
                                        d="M3 10.5H2.5C1.67157 10.5 1 9.82843 1 9V2C1 1.17157 1.67157 0.5 2.5 0.5H9.5C10.3284 0.5 11 1.17157 11 2V2.5"
                                        stroke="currentColor" stroke-width="1.5" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Thoughts container (hidden by default) -->
                    <div id="perplexity-thought" class="thought-container hidden">
                        <details>
                            <summary>üëÅÔ∏è View Reasoning Trace</summary>
                            <div class="thought-content"></div>
                        </details>
                    </div>
                    <div class="ai-response">
                        <div id="perplexity-response" class="response-text">Waiting for response...</div>
                    </div>
                    <div class="ai-status" id="perplexity-status"></div>
                </div>
            </div>
        </section>

        <!-- Workflow Results Section (Workflow Builder UI) -->
        <section id="workflowResultsSection" class="workflow-results-section hidden">
            <div class="workflow-builder-card">
                <div class="workflow-header">
                    <div class="workflow-header-left">
                        <span class="builder-badge">WORKFLOW BUILDER</span>
                        <h2 id="activeWorkflowName" class="workflow-title">Project: Discovery Phase</h2>
                    </div>
                    <div class="workflow-controls-top">
                        <div class="workflow-percentage" id="workflowProgressText">0% Complete</div>
                        <button id="pauseWorkflowBtn" class="control-btn tiny hidden">
                            <span class="icon">‚è∏</span> Pause
                        </button>
                    </div>
                </div>

                <div class="workflow-progress-bar">
                    <div id="workflowProgressBarFill" class="progress-fill" style="width: 0%"></div>
                </div>

                <div id="workflowStepsContainer" class="workflow-pipeline">
                    <!-- Workflow steps (Cards + Arrows) will be injected here -->
                </div>

                <div class="workflow-final-actions hidden" id="workflowFinalActions">
                    <div class="action-group">
                        <button id="workflowExportBtn" class="action-btn success">
                            <span class="icon">üì¶</span> Download All Results (.ZIP)
                        </button>
                        <button id="workflowResetBtn" class="action-btn secondary">
                            <span class="icon">üîÑ</span> New Project
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Edit Step Modal -->
        <div id="editStepModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Step Output</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="modal-tip">Refining this output will affect all subsequent steps in the pipeline.</p>
                    <textarea id="editStepTextArea" class="modal-textarea"></textarea>
                </div>
                <div class="modal-footer">
                    <button id="saveStepEditBtn" class="action-btn success">Save & Proceed</button>
                    <button id="cancelStepEditBtn" class="action-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interrogation Drawer -->
    <aside id="interrogationDrawer" class="interrogation-drawer">
        <div class="drawer-header">
            <h3 class="drawer-title">Expert Interrogation</h3>
            <button id="closeInterrogation" class="close-drawer">√ó</button>
        </div>
        <div class="drawer-content" id="interrogationContent">
            <div id="interrogationHistory" class="interrogation-history">
                <!-- Chat bubbles will go here -->
            </div>
            <div id="interrogationLoading" class="loading-state hidden">
                <div class="loading-spinner" style="width: 30px; height: 30px;"></div>
                <p style="font-size: 0.8rem;">Interrogating expert...</p>
            </div>
        </div>
        <div class="drawer-footer">
            <div class="interrogation-input-area">
                <textarea id="interrogationInput" class="interrogation-input"
                    placeholder="Ask a follow-up question..."></textarea>
                <button id="submitInterrogation" class="interrogate-submit">Send</button>
            </div>
        </div>
    </aside>

    <!-- Interrogation Modal -->
    <div id="triInterrogationModal" class="tri-modal-overlay">
        <div class="tri-modal">
            <div class="tri-modal-header">
                <h3>Interrogation</h3>
                <button class="tri-modal-close" onclick="closeInterrogation()">&times;</button>
            </div>
            <div class="tri-modal-body" id="triModalBody">
                <!-- Content injected by JS -->
            </div>
            <div class="tri-modal-footer">
                <a class="tri-modal-jump-link" id="triModalJumpLink" style="display:none;" onclick="jumpToSource()">
                    Jump to source in card
                </a>
                <button class="tri-modal-btn tri-modal-btn-close" onclick="closeInterrogation()">Close</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}?v=v10004"></script>
    <script>
    // ============================================
    // TriAI Interrogation Modal Controller
    // ============================================

    let currentInterrogation = {
        aiName: null,
        claim: null,
        violationType: null,
        cardElement: null,
        violationElement: null
    };

    function capitalize(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function getAIIcon(aiName) {
        const icons = {
            claude: 'Brown Circle',
            anthropic: 'Brown Circle',
            gemini: 'Blue Circle',
            google: 'Blue Circle',
            gpt: 'Green Circle',
            openai: 'Green Circle',
            perplexity: 'Blue Diamond'
        };
        return icons[aiName.toLowerCase()] || 'Robot';
    }

    function openInterrogation({ aiName, claim, violationType, cardElement }) {
        currentInterrogation = { aiName, claim, violationType, cardElement };

        const overlay = document.getElementById('triInterrogationModal');
        const body = document.getElementById('triModalBody');
        const jumpLink = document.getElementById('triModalJumpLink');

        body.innerHTML = `
            <span class="tri-modal-ai-badge ${aiName.toLowerCase()}">
                ${capitalize(aiName)}
            </span>
            <div class="tri-modal-violation-type">${violationType}</div>
            <div class="tri-modal-claim">
                <div class="tri-modal-claim-label">Flagged Claim</div>
                "${claim}"
            </div>
            <div class="tri-modal-loading" id="triModalLoading">
                <div class="tri-modal-spinner"></div>
                <div class="tri-modal-loading-text">Interrogating ${capitalize(aiName)}...</div>
            </div>
        `;

        jumpLink.style.display = 'none';
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        overlay.onclick = (e) => {
            if (e.target === overlay) closeInterrogation();
        };
        document.addEventListener('keydown', handleEscape);

        // Call the interrogation API
        fireInterrogationRequest(aiName, claim);
    }

    async function fireInterrogationRequest(aiName, claim) {
        const modelMap = {
            'openai': 'openai',
            'anthropic': 'anthropic',
            'google': 'google',
            'perplexity': 'perplexity'
        };
        const modelType = modelMap[aiName.toLowerCase()] || aiName.toLowerCase();

        // Get the AI's full response for context
        const responseEl = document.getElementById(`${modelType}-response`);
        const previousResponse = responseEl ? responseEl.innerText : '';

        try {
            const response = await fetch('/interrogate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: modelType,
                    question: `Verify this claim: "${claim}"`,
                    previous_response: previousResponse,
                    selected_text: claim
                })
            });

            const data = await response.json();

            if (data.success) {
                showInterrogationResult({
                    defended: data.outcome === 'DEFENDED',
                    response: data.defense || data.response || 'No response provided.',
                    credibilityScore: data.new_credibility || 100,
                    penalty: data.credibility_change || 0
                });

                // Update the credibility badge in the AI card
                updateCredibilityBadge(modelType, data.new_credibility, data.credibility_change);
            } else {
                showInterrogationError(new Error(data.error || 'Interrogation failed'));
            }
        } catch (err) {
            showInterrogationError(err);
        }
    }

    function updateCredibilityBadge(modelName, newScore, change) {
        const card = document.querySelector(`.ai-card[data-ai="${modelName}"]`);
        if (!card) return;

        let badge = card.querySelector('.credibility-badge');
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'credibility-badge';
            const header = card.querySelector('.ai-info');
            if (header) header.appendChild(badge);
        }

        const scoreClass = newScore >= 80 ? 'high' : newScore >= 50 ? 'medium' : 'low';
        badge.className = `credibility-badge ${scoreClass}`;
        badge.textContent = `${newScore}/100`;

        if (change && change !== 0) {
            const changeSpan = document.createElement('span');
            changeSpan.style.marginLeft = '6px';
            changeSpan.style.fontWeight = 'bold';
            changeSpan.textContent = change >= 0 ? `+${change}` : `${change}`;
            changeSpan.style.color = change >= 0 ? '#10b981' : '#ef4444';
            badge.appendChild(changeSpan);
        }
    }

    function showInterrogationResult(result) {
        const loading = document.getElementById('triModalLoading');
        const jumpLink = document.getElementById('triModalJumpLink');

        // Restore the inline violation indicator
        restoreViolationItem();

        // Mark the violation as processed with outcome color
        if (currentInterrogation.violationElement) {
            const el = currentInterrogation.violationElement;
            el.classList.add(result.defended ? 'interrogated-defended' : 'interrogated-withdrew');
        }

        if (!loading) return;

        const status = result.defended ? 'defended' : 'withdrew';
        const statusIcon = result.defended ? 'Checkmark' : 'X';
        const statusLabel = result.defended ? 'Claim Defended' : 'Claim Withdrawn';
        const scoreClass = result.credibilityScore >= 70 ? 'high'
                         : result.credibilityScore >= 40 ? 'medium'
                         : 'low';

        loading.outerHTML = `
            <div class="tri-modal-result ${status}">
                <div class="tri-modal-result-header ${status}">
                    ${statusLabel}
                </div>
                <div>${result.response}</div>
                ${result.penalty && result.penalty < 0 ? `
                    <div style="margin-top: 10px; font-size: 12px; color: #ff8888;">
                        Credibility Penalty: ${result.penalty} points
                    </div>
                ` : ''}
            </div>
            <div class="tri-modal-credibility">
                <div class="tri-modal-score ${scoreClass}">${result.credibilityScore}</div>
                <div>
                    <div class="tri-modal-score-label">Credibility Score</div>
                    <div style="font-size: 12px; color: #666;">${capitalize(currentInterrogation.aiName)}</div>
                </div>
            </div>
        `;

        if (currentInterrogation.cardElement) {
            jumpLink.style.display = 'inline-flex';
        }
    }

    function showInterrogationError(err) {
        const loading = document.getElementById('triModalLoading');

        // Restore the inline violation indicator
        restoreViolationItem();

        if (!loading) return;

        loading.outerHTML = `
            <div class="tri-modal-result withdrew">
                <div class="tri-modal-result-header withdrew">
                    Interrogation Failed
                </div>
                <div>Could not reach ${capitalize(currentInterrogation.aiName)} for interrogation.
                The claim remains flagged.</div>
                <div style="margin-top: 8px; font-size: 12px; color: #666;">${err.message || 'Network error'}</div>
            </div>
        `;
    }

    function closeInterrogation() {
        const overlay = document.getElementById('triInterrogationModal');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
        document.removeEventListener('keydown', handleEscape);

        // If closed early (before result), restore the violation item
        if (currentInterrogation.violationElement &&
            currentInterrogation.violationElement.classList.contains('interrogating')) {
            restoreViolationItem();
        }
    }

    function jumpToSource() {
        closeInterrogation();

        if (currentInterrogation.cardElement) {
            currentInterrogation.cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            currentInterrogation.cardElement.style.outline = '2px solid #ff4444';
            setTimeout(() => {
                currentInterrogation.cardElement.style.outline = '';
            }, 2000);
        }
    }

    function handleEscape(e) {
        if (e.key === 'Escape') closeInterrogation();
    }

    // Override the violation click handler to use the modal
    document.addEventListener('click', function(e) {
        const violationItem = e.target.closest('.violation-item');
        if (violationItem) {
            e.preventDefault();
            e.stopPropagation();

            // Immediate inline feedback - add pulsing class and spinner
            if (!violationItem.classList.contains('interrogating')) {
                violationItem.classList.add('interrogating');
                const originalContent = violationItem.innerHTML;
                violationItem.dataset.originalContent = originalContent;
                violationItem.innerHTML = `<span class="inline-interrogate-spinner"></span> ${originalContent}`;
            }

            const modelName = violationItem.dataset.ai;
            const violationText = violationItem.dataset.originalContent || violationItem.textContent.trim();

            // Extract the claim/number from the violation text
            const claimMatch = violationText.match(/'([^']+)'/);
            const claim = claimMatch ? claimMatch[1] : violationText;

            // Extract violation type
            const typeMatch = violationText.match(/^([A-Z_]+):/);
            const violationType = typeMatch ? typeMatch[1].replace(/_/g, ' ') : 'Violation';

            const cardElement = document.querySelector(`.ai-card[data-ai="${modelName}"]`);

            // Store reference to the clicked violation for later
            currentInterrogation.violationElement = violationItem;

            openInterrogation({
                aiName: modelName,
                claim: claim,
                violationType: violationType,
                cardElement: cardElement
            });
        }
    }, true); // Use capture to intercept before other handlers

    // Restore violation item after interrogation completes
    function restoreViolationItem() {
        if (currentInterrogation.violationElement) {
            const el = currentInterrogation.violationElement;
            el.classList.remove('interrogating');
            if (el.dataset.originalContent) {
                el.innerHTML = el.dataset.originalContent;
                delete el.dataset.originalContent;
            }
        }
    }
    </script>
</body>

</html>
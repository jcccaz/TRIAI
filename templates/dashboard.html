<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TriAI Mission Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CustomScrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2dd4bf;
        }

        /* Grainy Texture */
        .noise-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 50;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opactiy='1'/%3E%3C/svg%3E");
        }

        /* Glass Panels */
        .glass-panel {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(212, 180, 131, 0.08);
            /* Subtle Gold Border */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            border-radius: 0.5rem;
        }

        /* Scanline Effect (subtle) */
        .scanline {
            width: 100%;
            height: 1px;
            background: rgba(45, 212, 191, 0.1);
            position: absolute;
            z-index: 40;
            animation: scan 8s linear infinite;
            pointer-events: none;
        }

        @keyframes scan {
            0% {
                top: 0%;
            }

            100% {
                top: 100%;
            }
        }

        .status-dot {
            height: 6px;
            width: 6px;
            border-radius: 50%;
            display: inline-block;
        }

        .font-mono-tech {
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        triai: {
                            bg: '#050505',
                            panel: '#0a0a0a',
                            gold: '#d4b483',      /* The "Digital Gold" Text Color */
                            gold_dim: '#8a7a5c',
                            teal: '#2dd4bf',      /* The "Electric Teal" Accent */
                            teal_dim: '#115e59',
                            red: '#ef4444',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>
</head>

<body
    class="bg-triai-bg text-slate-300 font-sans h-screen flex flex-col overflow-hidden selection:bg-triai-teal selection:text-black">

    <div class="noise-bg"></div>
    <div class="scanline"></div>

    <!-- ðŸ›‘ SYSTEM INITIALIZATION OVERLAY -->
    <div id="sys-init-overlay"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:#050505; z-index:100; display:flex; align-items:center; justify-content:center; flex-direction:column; transition:opacity 0.8s ease-out;">
        <div class="text-center group cursor-pointer" onclick="initSystem()">
            <div
                class="w-16 h-16 mx-auto mb-4 border border-triai-teal/30 rounded-full flex items-center justify-center animate-pulse group-hover:border-triai-gold/50 transition-colors">
                <i data-lucide="fingerprint"
                    class="w-8 h-8 text-triai-teal group-hover:text-triai-gold transition-colors"></i>
            </div>
            <h1 class="text-triai-gold font-mono-tech tracking-[0.3em] text-sm uppercase">Initialize System</h1>
            <p
                class="text-slate-600 text-[10px] mt-2 tracking-widest group-hover:text-triai-teal transition-colors font-mono">
                Status: Awaiting Input...</p>
        </div>
    </div>

    <script>
        function initSystem() {
            const overlay = document.getElementById('sys-init-overlay');
            overlay.style.pointerEvents = 'none';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 1000);

            // ðŸ”Š Play Welcome Audio
            fetch('/api/voice/welcome')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.path) {
                        const audio = new Audio(data.path);
                        audio.volume = 0.8;
                        audio.play().catch(e => console.log("Audio play failed (interaction required?)", e));
                    }
                })
                .catch(err => console.error("Voice load error", err));
        }
    </script>

    <!-- ðŸŸ¦ TOP BAR -->
    <header
        class="h-12 border-b border-white/5 bg-black/40 backdrop-blur-md flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-6">
            <!-- Logo -->
            <div class="flex items-center gap-2 font-bold tracking-widest text-triai-gold uppercase text-sm">
                <i data-lucide="pyramid" class="w-5 h-5 text-triai-teal"></i>
                TriAI <span class="text-slate-600">â–º</span> Control
            </div>

            <div class="h-4 w-px bg-white/10"></div>

            <!-- Stats Ticker -->
            <div class="flex items-center gap-6 text-[10px] uppercase tracking-wider font-mono-tech text-slate-500">
                <span>Models: <span class="text-white" id="model-count">4 Active</span></span>
                <span>Personas: <span class="text-white">12</span></span>
                <span>Cost Today: <span class="text-triai-teal" id="cost-today">--</span></span>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 px-3 py-1 bg-white/5 rounded border border-white/5">
                <span class="status-dot bg-triai-teal animate-pulse shadow-[0_0_8px_rgba(45,212,191,0.6)]"></span>
                <span class="text-[10px] text-triai-teal font-mono tracking-tight" id="system-status">NOMINAL</span>
            </div>
            <button class="text-slate-600 hover:text-triai-gold transition-colors"><i data-lucide="settings"
                    class="w-4 h-4"></i></button>
        </div>
    </header>

    <!-- MAIN GRID -->
    <main
        class="flex-1 p-6 overflow-hidden relative z-10 grid grid-cols-12 grid-rows-12 gap-5 max-w-[1800px] mx-auto w-full">

        <!-- ðŸ§  ROW 1: KPI CARDS (Col 1-9) -->
        <div class="col-span-12 lg:col-span-9 row-span-2 grid grid-cols-4 gap-4">
            <!-- KPI 1 -->
            <div
                class="glass-panel p-4 flex flex-col justify-between group hover:border-triai-teal/30 transition-colors">
                <span class="text-[10px] uppercase tracking-widest text-slate-500">Prompts (24h)</span>
                <div
                    class="text-2xl font-light text-white font-mono-tech group-hover:text-triai-teal transition-colors">
                    1,284</div>
                <div class="h-1 w-full bg-slate-800 mt-2 rounded-full overflow-hidden">
                    <div class="h-full bg-slate-600 w-[65%]"></div>
                </div>
            </div>
            <!-- KPI 2 -->
            <div
                class="glass-panel p-4 flex flex-col justify-between group hover:border-triai-teal/30 transition-colors">
                <span class="text-[10px] uppercase tracking-widest text-slate-500">Cost (7d)</span>
                <div class="text-2xl font-light text-triai-gold font-mono-tech">$38.12</div>
                <span class="text-[9px] text-triai-teal">â–² 8% vs last week</span>
            </div>
            <!-- KPI 3 -->
            <div
                class="glass-panel p-4 flex flex-col justify-between group hover:border-triai-teal/30 transition-colors">
                <span class="text-[10px] uppercase tracking-widest text-slate-500">Avg Cost/Prompt</span>
                <div class="text-2xl font-light text-white font-mono-tech group-hover:text-triai-teal transition-colors"
                    id="avg-cost">--</div>
            </div>
            <!-- KPI 4 -->
            <div class="glass-panel p-4 flex flex-col justify-between relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="crown"
                        class="w-12 h-12 text-triai-gold"></i></div>
                <span class="text-[10px] uppercase tracking-widest text-triai-gold">Most Used</span>
                <div class="text-xl font-medium text-white">Architect</div>
                <span class="text-[9px] text-slate-500">Claude 3.5 Sonnet</span>
            </div>
        </div>

        <!-- ðŸ”® RIGHT RAIL: STACKS (Col 10-12) -->
        <div class="col-span-12 lg:col-span-3 row-span-6 glass-panel p-5 flex flex-col">
            <h3
                class="text-xs font-semibold text-triai-gold uppercase tracking-widest mb-4 border-b border-white/5 pb-2">
                Top Stacks</h3>

            <div class="space-y-4 font-mono-tech text-sm">
                <!-- Stack 1 -->
                <div class="group cursor-pointer">
                    <div class="flex items-center gap-2 text-white mb-1">
                        <span class="text-triai-teal">Architect</span> <span class="text-slate-600">â–º</span> Defender
                        <span class="text-slate-600">â–º</span> Auditor
                    </div>
                    <div class="flex justify-between text-slate-500 text-[10px]">
                        <span>67 runs</span>
                        <span class="group-hover:text-triai-gold transition-colors">$0.051 avg</span>
                    </div>
                </div>
                <!-- Stack 2 -->
                <div class="group cursor-pointer">
                    <div class="flex items-center gap-2 text-slate-300 mb-1">
                        Critic <span class="text-slate-600">â–º</span> Strategist
                    </div>
                    <div class="flex justify-between text-slate-500 text-[10px]">
                        <span>42 runs</span>
                        <span class="group-hover:text-triai-gold transition-colors">$0.037 avg</span>
                    </div>
                </div>
                <!-- Stack 3 -->
                <div class="group cursor-pointer">
                    <div class="flex items-center gap-2 text-slate-300 mb-1">
                        Analyst <span class="text-slate-600">â–º</span> CFO <span class="text-slate-600">â–º</span> Lecturer
                    </div>
                    <div class="flex justify-between text-slate-500 text-[10px]">
                        <span>21 runs</span>
                        <span class="group-hover:text-triai-gold transition-colors">$0.019 avg</span>
                    </div>
                </div>
            </div>

            <div class="mt-8 border-t border-white/5 pt-4">
                <h3 class="text-xs font-semibold text-triai-gold uppercase tracking-widest mb-3">System Status</h3>
                <div class="space-y-3 font-mono-tech text-xs">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2"><i data-lucide="train" class="w-3 h-3 text-triai-teal"></i>
                            Railway Web</div>
                        <span class="text-slate-400" id="railway-uptime">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2"><i data-lucide="database"
                                class="w-3 h-3 text-blue-400"></i> Postgres</div>
                        <span class="text-slate-400" id="postgres-rows">-- rows</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2"><i data-lucide="server" class="w-3 h-3 text-slate-600"></i>
                            AWS EC2</div>
                        <span class="text-slate-600" id="aws-status">Stopped</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ðŸŽ­ ROW 2: MAIN GRID (Col 1-9) -->
        <div class="col-span-12 lg:col-span-9 row-span-6 glass-panel p-0 flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="px-5 py-3 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                <span class="text-xs font-semibold text-slate-300 uppercase tracking-widest">Persona Ã— Model
                    Density</span>
                <div class="flex gap-2 text-[10px] font-mono text-slate-500">
                    <span class="flex items-center gap-1"><span
                            class="w-2 h-2 bg-triai-teal/20 border border-triai-teal rounded-sm"></span> High
                        Usage</span>
                    <span class="flex items-center gap-1"><span
                            class="w-2 h-2 bg-slate-800 border border-slate-700 rounded-sm"></span> Idle</span>
                </div>
            </div>

            <!-- THE GRID -->
            <div class="flex-1 overflow-auto p-4">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[10px] uppercase text-slate-500 border-b border-white/5">
                            <th class="pb-2 font-normal pl-2">Role</th>
                            <th class="pb-2 font-normal text-center">OpenAI GPT-4o</th>
                            <th class="pb-2 font-normal text-center">Anthropic Claude</th>
                            <th class="pb-2 font-normal text-center">Google Gemini</th>
                            <th class="pb-2 font-normal text-center">Perplexity</th>
                        </tr>
                    </thead>
                    <tbody class="font-mono-tech text-xs divide-y divide-white/5">
                        <!-- Row 1: Architect -->
                        <tr class="group hover:bg-white/[0.02] transition-colors">
                            <td class="py-3 pl-2 text-white">Architect</td>
                            <td class="py-3 text-center">
                                <div
                                    class="flex flex-col items-center bg-triai-teal/10 py-1 rounded border border-triai-teal/20 mx-2">
                                    <span class="text-triai-teal font-bold">184</span>
                                    <span class="text-[9px] text-slate-500">$2.16</span>
                                </div>
                            </td>
                            <td class="py-3 text-center">
                                <div
                                    class="flex flex-col items-center bg-triai-gold/10 py-1 rounded border border-triai-gold/20 mx-2">
                                    <span class="text-triai-gold font-bold">249</span>
                                    <span class="text-[9px] text-slate-500">$2.21</span>
                                </div>
                            </td>
                            <td class="py-3 text-center">
                                <div class="flex flex-col items-center mx-2 opacity-60">
                                    <span class="text-slate-400">27</span>
                                    <span class="text-[9px] text-slate-600">$0.29</span>
                                </div>
                            </td>
                            <td class="py-3 text-center text-slate-700">---</td>
                        </tr>

                        <!-- Row 2: Defender -->
                        <tr class="group hover:bg-white/[0.02] transition-colors">
                            <td class="py-3 pl-2 text-white">Defender</td>
                            <td class="py-3 text-center text-slate-700">---</td>
                            <td class="py-3 text-center text-slate-700">---</td>
                            <td class="py-3 text-center">
                                <div
                                    class="flex flex-col items-center bg-triai-teal/10 py-1 rounded border border-triai-teal/20 mx-2">
                                    <span class="text-triai-teal font-bold">368</span>
                                    <span class="text-[9px] text-slate-500">$2.94</span>
                                </div>
                            </td>
                            <td class="py-3 text-center text-slate-700">---</td>
                        </tr>

                        <!-- Row 3: Truth Auditor -->
                        <tr class="group hover:bg-white/[0.02] transition-colors">
                            <td class="py-3 pl-2 text-white">Truth Auditor</td>
                            <td class="py-3 text-center">
                                <div class="flex flex-col items-center mx-2 opacity-60">
                                    <span class="text-slate-400">110</span>
                                    <span class="text-[9px] text-slate-600">$2.92</span>
                                </div>
                            </td>
                            <td class="py-3 text-center">
                                <div class="flex flex-col items-center mx-2 opacity-60">
                                    <span class="text-slate-400">207</span>
                                    <span class="text-[9px] text-slate-600">$2.82</span>
                                </div>
                            </td>
                            <td class="py-3 text-center text-slate-700">---</td>
                            <td class="py-3 text-center text-slate-700">---</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ðŸ’¸ ROW 3: COST CHART (Col 1-9) -->
        <div class="col-span-12 lg:col-span-9 row-span-4 glass-panel p-5 relative overflow-hidden">
            <div class="flex justify-between items-center mb-2 z-10 relative">
                <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-widest">Cost per Prompt (7d)</h3>
                <div class="flex gap-2">
                    <button class="px-2 py-1 bg-white/5 text-[10px] text-white rounded hover:bg-white/10">7D</button>
                    <button class="px-2 py-1 text-[10px] text-slate-600 hover:text-white">30D</button>
                </div>
            </div>
            <div class="w-full h-[90%] z-0">
                <canvas id="costChart"></canvas>
            </div>
        </div>

        <!-- ðŸ”® ROW 3: ANOMALY LOG (Col 10-12) -->
        <div class="col-span-12 lg:col-span-3 row-span-6 glass-panel p-0 flex flex-col overflow-hidden">
            <div class="px-5 py-3 border-b border-white/5 bg-red-900/[0.05]">
                <h3 class="text-xs font-semibold text-triai-red uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-3 h-3"></i> Truth & Anomalies
                </h3>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-4 font-mono-tech text-xs" id="cassandra-log-container">
                <!-- Log Item -->
                <div class="relative pl-3 border-l-2 border-triai-red/50">
                    <div class="flex justify-between text-slate-500 mb-1">
                        <span>Claude / Cassandra</span>
                        <span>01:46 PM</span>
                    </div>
                    <div class="text-slate-300">Hallucination detected. <span class="text-triai-red">Flagged token
                            density high.</span></div>
                </div>
                <!-- Log Item -->
                <div class="relative pl-3 border-l-2 border-yellow-500/50">
                    <div class="flex justify-between text-slate-500 mb-1">
                        <span>Gemini / Strategist</span>
                        <span>01:18 PM</span>
                    </div>
                    <div class="text-slate-300">Output unverifiable. Confidence mismatch.</div>
                </div>
                <!-- Log Item -->
                <div class="relative pl-3 border-l-2 border-triai-teal/50">
                    <div class="flex justify-between text-slate-500 mb-1">
                        <span>Truth Auditor</span>
                        <span>12:06 PM</span>
                    </div>
                    <div class="text-slate-300">Consensus across PTM achieved. 98% confidence.</div>
                </div>
            </div>
        </div>

    </main>

    <script>
        lucide.createIcons();

        // fetch real data
        fetch('/api/telemetry')
            .then(res => res.json())
            .then(data => {
                // Update basic stats
                document.getElementById('avg-cost').innerText = '$' + data.costs.avg_cost_per_prompt;
                document.getElementById('cost-today').innerText = '$' + data.costs.daily_total;
                document.getElementById('railway-uptime').innerText = data.infra.railway_uptime;
                document.getElementById('postgres-rows').innerText = data.infra.postgres_rows + ' rows';
                document.getElementById('aws-status').innerText = data.infra.aws_status;

                // Colorize status
                const sysStatus = document.getElementById('system-status');
                if (data.status === 'nominal') {
                    sysStatus.innerText = "NOMINAL";
                    sysStatus.classList.add('text-triai-teal');
                } else {
                    sysStatus.innerText = "WARNING";
                    sysStatus.classList.add('text-triai-red');
                }

                // ðŸ“Š Render Persona Table
                if (data.persona_density) {
                    const tbody = document.querySelector('tbody');
                    tbody.innerHTML = ''; // Clear hardcoded rows

                    // Sort personas by total usage (optional, but nice)
                    const sortedPersonas = Object.keys(data.persona_density).sort((a, b) => {
                        const sumA = Object.values(data.persona_density[a]).reduce((x, y) => x + y, 0);
                        const sumB = Object.values(data.persona_density[b]).reduce((x, y) => x + y, 0);
                        return sumB - sumA;
                    });

                    sortedPersonas.forEach(persona => {
                        const counts = data.persona_density[persona];
                        const tr = document.createElement('tr');
                        tr.className = "group hover:bg-white/[0.02] transition-colors";

                        // Persona Name
                        tr.innerHTML = `<td class="py-3 pl-2 text-white">${persona}</td>`;

                        // Providers: OpenAI, Anthropic, Google, Perplexity
                        ['openai', 'anthropic', 'google', 'perplexity'].forEach(prov => {
                            const count = counts[prov] || 0;
                            // Estimate cost (rough avg 0.03/msg)
                            const cost = (count * 0.03).toFixed(2);

                            let cellContent = `<span class="text-slate-700">---</span>`;

                            if (count > 0) {
                                // Dynamic Styling
                                let styleClass = "opacity-60 text-slate-400"; // Low usage
                                let borderClass = "";

                                if (count > 50) { // High usage = Teal
                                    styleClass = "bg-triai-teal/10 border-triai-teal/20 text-triai-teal font-bold";
                                    borderClass = "border rounded";
                                } else if (count > 20) { // Med usage = Gold
                                    styleClass = "bg-triai-gold/10 border-triai-gold/20 text-triai-gold font-bold";
                                    borderClass = "border rounded";
                                }

                                cellContent = `
                                    <div class="flex flex-col items-center mx-2 py-1 ${styleClass} ${borderClass}">
                                        <span>${count}</span>
                                        <span class="text-[9px] font-normal opacity-70">$${cost}</span>
                                    </div>
                                `;
                            }

                            tr.innerHTML += `<td class="py-3 text-center">${cellContent}</td>`;
                        });

                        tbody.appendChild(tr);
                    });
                }

            })
            .catch(err => console.error("Telemetry fetch failed", err));

        // Chart Setup (Gold/Teal Theme)
        const ctx = document.getElementById('costChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(212, 180, 131, 0.2)'); // Gold
        gradient.addColorStop(1, 'rgba(212, 180, 131, 0)');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Apr 17', 'Apr 18', 'Apr 19', 'Apr 20', 'Apr 21', 'Apr 22', 'Apr 23'],
                datasets: [{
                    data: [0.018, 0.015, 0.022, 0.019, 0.028, 0.035, 0.029],
                    borderColor: '#d4b483', // Gold
                    backgroundColor: gradient,
                    borderWidth: 1.5,
                    pointRadius: 2,
                    pointBackgroundColor: '#050505',
                    pointBorderColor: '#d4b483',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#64748b', font: { family: 'JetBrains Mono', size: 9 }, callback: (val) => '$' + val }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#64748b', font: { family: 'JetBrains Mono', size: 9 } }
                    }
                }
            }
        });
    </script>
</body>

</html>